<!DOCTYPE html>

<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
  </head>

  <style>
    :root {
      --color-text: #bfbdb6;
      --color-background: #10141c;
      --color-background2: #30343c;
      --color-border: #6c738099;
      --color-error:  #f26d78b3;
      --color-selected: #670033;
    }

    input {
      color: inherit;
      background-color: inherit;
    }

    input:focus {
      color: inherit;
      background-color: inherit;
    }

    /* Scrollbars */
    ::-webkit-scrollbar {
      width: 7px;
    }

    ::-webkit-scrollbar-track,
    ::-webkit-scrollbar-corner {
      background: var(--color-background);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--color-border);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--color-selected);
    }

    html,
    html * {
      scrollbar-color: var(--color-border) var(--color-background);
      scrollbar-width: thin;
    }
  </style>

  <body
    style="
      background-color: var(--color-background);
      color: var(--color-text);
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    "
  >
    <div id="main"></div>
  </body>

  <script type="text/javascript" src="/PapaParse.js"></script>

  <script type="text/javascript">
    let globalState = {
      currentYear: 2022,
      data: {
        2020: [],
        2021: [],
        2022: [],
      },
      dom: {
        main: document.getElementById("main"),

        passwordBox: {
          container: document.createElement("div"),
          input: document.createElement("input"),
          label: document.createElement("div"),
          button: document.createElement("div"),
          buttonText: document.createElement("div"),
          errorText: document.createElement("div"),
        },

        data: {
          container: document.createElement("div"),
          datesTableContainer: document.createElement("div"),
          surveyTableContainer: document.createElement("div"),
          surveyCompletionsContainer: document.createElement("div"),
          surveyTable: document.createElement("div"),
          surveyCompletions: document.createElement("div"),
        },

        loading: document.createElement("div"),
      },
    }

    const arrSum = (arr) => {
      let result = 0
      for (let val of arr) {
        result += val
      }
      return result
    }

    const seq = (start, step, count) => {
      let result = [start]
      for (let i = 1; i < count; i += 1) {
        result.push(start + i * step)
      }
      return result
    }

    const dateSeq = (start, step, count) => {
      
      let result = []
      
      let startDate = new Date(start)
      let startDayIndex = startDate.getDate()

      for (let i = 0; i < count; i++) {
        let newDayIndex = startDayIndex + step * i
        let newDate = new Date(startDate)
        newDate.setDate(newDayIndex)
        result.push(newDate)
      }

      return result
    }

    const formatDate = (date) => {
      let result = date.toISOString().slice(0, 10)
      return result
    }

    const tableContainerStyle = (widthPx) => {
      let scrollbarWidth = 15 // TODO(sen) Something better than a guess here
      result = "height: calc(100vh - " + scrollbarWidth + 
      "px); overflow-x: hidden; overflow-y: scroll; width: " 
      + (widthPx + scrollbarWidth) + 
      "px; display: flex; justify-content: center; flex-shrink: 0;"
      return result
    }

    const createTableCellElement = (widthPx) => {
      let cellElement = document.createElement("div")
      cellElement.setAttribute(
        "style", 
        "width: " + widthPx + "px; display: flex; align-items: center; justify-content: center;"
      )
      return cellElement
    }

    const createTableCellStringElement = (widthPx, string) => {
      let cellElement = createTableCellElement(widthPx)
      cellElement.innerHTML = string
      return cellElement
    }

    const createTableRowElement = (color) => {
      let rowElement = document.createElement("div")
      rowElement.setAttribute("style", "display: flex; height: 30px;" + "background-color: " + color + ";")
      return rowElement      
    }

    const createTableTitleElement = (title) => {
      let titleElement = document.createElement("div")
      titleElement.setAttribute(
        "style", 
        "display: flex; align-items: center; justify-content: center; background-color: var(--color-background2);"
      )
      titleElement.innerHTML = title
      return titleElement
    }

    const createTableHeaderRowElement = (colWidthsPx) => {
      let headerRow = createTableRowElement("var(--color-border)")
      let colnames = Object.keys(colWidthsPx)

      for (colname of colnames) {
        let colWidthPx = colWidthsPx[colname]
        let headerElement = createTableCellElement(colWidthPx)
        headerRow.appendChild(headerElement)
        headerElement.innerHTML = colname
      }

      return headerRow
    }

    const createTableDataRowElement = (rowIndex) => {
      color = "var(--color-background)"
      if (rowIndex % 2 == 1) {
        color = "var(--color-background2)"
      }
      let rowElement = createTableRowElement(color)
      return rowElement
    }

    const createTableElementFromSoa = (soa, formatters, colWidthsPx, title) => {
      
      let tableWidthPx = arrSum(Object.values(colWidthsPx))

      let table = document.createElement("div")
      let colnames = Object.keys(soa)
      table.setAttribute("style", "width:" + tableWidthPx + "px;")

      let titleElement = createTableTitleElement(title)
      table.appendChild(titleElement)

      let headerRow = createTableHeaderRowElement(colWidthsPx)
      table.appendChild(headerRow)

      if (colnames.length > 0) {
        let rowCount = soa[colnames[0]].length

        for (let rowIndex = 0; rowIndex < rowCount; rowIndex += 1) {
          let rowElement = createTableDataRowElement(rowIndex)
          table.appendChild(rowElement)

          for (colname of colnames) {
            let colData = soa[colname][rowIndex]
            let formatter = formatters[colname]
            let colDataFormatted = formatter(colData)

            let colWidthPx = colWidthsPx[colname]
            let cellElement = createTableCellStringElement(colWidthPx, colDataFormatted)
            rowElement.appendChild(cellElement)
          }
        }        
      }

      return [table, tableWidthPx]
    }

    const parseCsv = (input) => {
      let result = []
      let papaResult = Papa.parse(
        input, 
        { delimiter: ",", header: true, skipEmptyLines: true, dynamicTyping: false}
      )
      if (papaResult.errors.length > 0) {
        console.error("CSV parsing errors")
        console.error(papaResult)
      } else {
        result = papaResult.data
      }
      return result
    }

    const updateSurveyTable = () => {

      globalState.dom.data.surveyTableContainer.removeChild(globalState.dom.data.surveyTable)
      globalState.dom.data.surveyTable = document.createElement("div")
      let table = globalState.dom.data.surveyTable
      globalState.dom.data.surveyTableContainer.appendChild(table)

      let allData = globalState.data[globalState.currentYear]

      let colWidthsPx = {
        record_id: 100,
        week: 100,
        completed: 100,
        ari: 100,
      }
      let tableWidthPx = arrSum(Object.values(colWidthsPx))
      table.setAttribute("style", "width: " + tableWidthPx + "px;")
      globalState.dom.data.surveyTableContainer.setAttribute(
        "style", tableContainerStyle(tableWidthPx)
      )

      table.appendChild(createTableTitleElement("Weekly surveys"))
      table.appendChild(createTableHeaderRowElement(colWidthsPx))

      let completions = {}
      let rowsShown = 0
      for (let row of allData) {
        if (row.redcap_event_name !== undefined && row.redcap_event_name !== null) {

          if (row.redcap_event_name.startsWith("weekly_survey")) {
            let weekMatch = /weekly_survey_(\d+)_arm_1/.exec(row.redcap_event_name)
            if (weekMatch !== null && weekMatch.length === 2) {
            
              let week = weekMatch[1]

              let rowElement = createTableDataRowElement(rowsShown)
              rowsShown += 1
              table.appendChild(rowElement)

              let recordIdCell = createTableCellStringElement(colWidthsPx.record_id, row.record_id)
              rowElement.appendChild(recordIdCell)

              let weekCell = createTableCellStringElement(colWidthsPx.week, week)
              rowElement.appendChild(weekCell)

              let completed = row.weekly_symptom_survey_complete
              let completedCell = createTableCellStringElement(colWidthsPx.completed, completed)
              rowElement.appendChild(completedCell)

              let ari = row.ari_definition
              let ariCell = createTableCellStringElement(colWidthsPx.ari, ari)
              rowElement.appendChild(ariCell)

              if (completed !== "0") {
                if (completions[row.record_id] === undefined) {
                  completions[row.record_id] = []
                }
                completions[row.record_id].push(parseInt(week))
              }

            } else {

              console.error("failed to extract week from ", row)
            }
          }
        } else {

          console.error("no event field in row", row)
        }
      }

      return completions
    }

    const updateCompletionsTable = (completions) => {

      globalState.dom.data.surveyCompletionsContainer.removeChild(globalState.dom.data.surveyCompletions)
      globalState.dom.data.surveyCompletions = document.createElement("div")
      let table = globalState.dom.data.surveyCompletions
      globalState.dom.data.surveyCompletionsContainer.appendChild(table)

      let colWidthsPx = {
        record_id: 100,
        completions: 300,
      }
      let tableWidthPx = arrSum(Object.values(colWidthsPx))
      table.setAttribute("style", "width: " + tableWidthPx + "px;")
      globalState.dom.data.surveyCompletionsContainer.setAttribute(
        "style", tableContainerStyle(tableWidthPx)
      )

      table.appendChild(createTableTitleElement("Weekly completions"))
      table.appendChild(createTableHeaderRowElement(colWidthsPx))

      let rowsShown = 0
      for ([record, completedSurveys] of Object.entries(completions)) {
        let rowElement = createTableDataRowElement(rowsShown)
        table.appendChild(rowElement)
        rowsShown += 1

        rowElement.appendChild(createTableCellStringElement(colWidthsPx.record_id, record))
        
        let collapsedCompletions = ""
        if (completedSurveys.length > 0) {
          collapsedCompletions += completedSurveys[0]
          if (completedSurveys.length > 1) {

            let prev = completedSurveys[0]
            let currentStreak = 1
            for (let completeIndex = 1; completeIndex < completedSurveys.length; completeIndex += 1) {
              let compl = completedSurveys[completeIndex]

              if (completeIndex == completedSurveys.length - 1) {
              
                if (currentStreak > 1) {
                  collapsedCompletions += "-"
                } else {
                  collapsedCompletions += ", "
                }
                collapsedCompletions += compl
              
              } else if (compl - prev == currentStreak) {

                currentStreak += 1

              } else {

                if (currentStreak > 1) {
                  let lastNotShown = prev + currentStreak - 1
                  collapsedCompletions += "-" + lastNotShown + ", "
                }

                collapsedCompletions += compl
                currentStreak = 1
              }

            }
          }
        }

        rowElement.appendChild(createTableCellStringElement(colWidthsPx.completions, collapsedCompletions))
      }
    }

    const updateData = async (password, years) => {
      let success = true

      if (
        password === "" ||
        password === null ||
        password === undefined ||
        !(typeof password === "string" || password instanceof String)
      ) {

        success = false

      } else {

        for (let year of years) {
          let address =
            "https://reports2.hcwflustudy.com/api/" +
            password +
            "/redcap" +
            year +
            ".csv"

          //address = "/pull-redcap/redcap2022-newcastle.csv"

          try {
            resp = await fetch(address)
            if (resp.status !== 200) {
              success = false
            }
            text = await resp.text()
            parsed = parseCsv(text)
            globalState.data[year] = parsed
          } catch (e) {
            success = false
            console.error(e)
          }

          if (!success) {
            break
          }
        }

        if (success) {
          let completions = updateSurveyTable()
          updateCompletionsTable(completions)
        }
      }

      return success
    }

    //
    // NOTE(sen) DOM secton
    //

    // NOTE(sen) Init password box
    {
      let dom = globalState.dom

      let container = dom.passwordBox.container
      let input = dom.passwordBox.input
      let label = dom.passwordBox.label
      let button = dom.passwordBox.button
      let buttonText = dom.passwordBox.buttonText
      let errorText = dom.passwordBox.errorText
      container.appendChild(label)
      container.appendChild(input)
      container.appendChild(button)
      container.appendChild(errorText)
      button.appendChild(buttonText)

      input.setAttribute("type", "password")
      input.setAttribute("style", "width: 75vw; height: 2em;")

      label.innerHTML = "Password"
      buttonText.innerHTML = "Submit"

      container.setAttribute(
        "style",
        "width: 75vw; margin: auto; margin-top: 5vh"
      )

      button.setAttribute(
        "style",
        "cursor: pointer; border: 1px solid var(--color-border); height: 50px; width: 50%; margin: auto; margin-top: 10px; display: flex; align-items: center; justify-content: center;"
      )

      errorText.setAttribute(
        "style",
        "color: var(--color-error); text-align: center; margin-top: 10px"
      )

      button.addEventListener("click", (e) => {
        errorText.innerHTML = ""
        if (input.value === "") {
          errorText.innerHTML = "Password is empty"
        } else {
          buttonText.innerHTML = "..."
          updateData(input.value, [globalState.currentYear]).then((updateSuccess) => {
            buttonText.innerHTML = "Submit"
            if (!updateSuccess) {
              errorText.innerHTML = "Not recognized"
            } else {
              localStorage.setItem("password", input.value)
              dom.main.removeChild(container)
              dom.main.appendChild(dom.data.container)
            }
          })
        }
      })
    }

    // NOTE(sen) Init data page
    {
      let dom = globalState.dom
      let container = dom.data.container
      let datesTableContainer = dom.data.datesTableContainer
      let surveyTableContainer = dom.data.surveyTableContainer
      let surveyCompletionsContainer = dom.data.surveyCompletionsContainer
      let surveyTable = dom.data.surveyTable
      let surveyCompletions = dom.data.surveyCompletions
      container.appendChild(datesTableContainer)
      container.appendChild(surveyTableContainer)
      container.appendChild(surveyCompletionsContainer)
      surveyTableContainer.appendChild(surveyTable)
      surveyCompletionsContainer.appendChild(surveyCompletions)

      container.setAttribute("id", "dom-data-container")
      container.setAttribute("style", "display: flex")

      // NOTE(sen) Dates of weekly surveys only since we know them in advance

      weeklySurveyDates2022 = {
        week: seq(1, 1, 52),
        start: dateSeq("2022-01-03", 7, 52),
        end: dateSeq("2022-01-09", 7, 52),
        send: dateSeq("2022-01-10", 7, 52),
      }

      let [weeklySurveyDates2022Table, tableWidth] = createTableElementFromSoa(
          weeklySurveyDates2022, 
          {
            week: (x) => x,
            start: formatDate,
            end: formatDate,
            send: formatDate,
          },
          {
            week: 50,
            start: 100,
            end: 100,
            send: 100,
          },
          "Weekly survey dates 2022"
        )

      datesTableContainer.appendChild(weeklySurveyDates2022Table)
      datesTableContainer.setAttribute("style", tableContainerStyle(tableWidth))
    }

    // NOTE(sen) Init loading indicator
    {
      let dom = globalState.dom
      let loading = dom.loading
      loading.setAttribute(
        "style", 
        "font-size: 40px; display: flex; align-items: center; justify-content: center; height: 100vh"
      )
      loading.innerHTML = "Loading..."
    }

    // NOTE(sen) Attempt to login from local storage
    {
      let dom = globalState.dom
      let password = localStorage.getItem("password")
      
      if (password === null) {
      
        dom.main.appendChild(dom.passwordBox.container)
      
      } else {

        dom.main.appendChild(dom.loading)
        updateData(password, [globalState.currentYear]).then((updateSuccess) => {          
          dom.main.removeChild(dom.loading)

          if (!updateSuccess) {
            localStorage.removeItem("password")
            dom.main.appendChild(dom.passwordBox.container)
          } else {
            dom.main.appendChild(dom.data.container)
          }
        })
      
      }
    }
  </script>
</html>
