<!DOCTYPE html>

<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
  </head>

  <style>
    :root {
      --color-text: #bfbdb6;
      --color-background: #10141c;
      --color-background2: #30343c;
      --color-border: #474d56;
      --color-error:  #f26d78;
      --color-selected: #670033;
    }

    input {
      color: inherit;
      background-color: inherit;
    }

    input:focus {
      color: inherit;
      background-color: inherit;
    }

    /* Scrollbars */
    ::-webkit-scrollbar {
      width: 15px;
    }

    ::-webkit-scrollbar-track,
    ::-webkit-scrollbar-corner {
      background: var(--color-background);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--color-border);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--color-selected);
    }

    html,
    html * {
      scrollbar-color: var(--color-border) var(--color-background);
      scrollbar-width: thin;
    }
  </style>

  <body
    style="
      background-color: var(--color-background);
      color: var(--color-text);
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    "
  >
    <div id="main"></div>
  </body>

  <script type="module">

    const getScrollbarWidths = () => {
      let outer = document.createElement('div');
      outer.style.visibility = "hidden";
      outer.style.overflowY = "scroll";
      document.body.appendChild(outer);

      let inner = document.createElement('div');
      outer.appendChild(inner);

      let scrollbarWidthV = (outer.offsetWidth - inner.offsetWidth);
      outer.removeChild(inner)

      outer.style.overflowY = "hidden"
      outer.style.overflowX = "scroll"

      outer.appendChild(inner)
      let scrollbarWidthH = outer.offsetHeight - inner.offsetHeight

      outer.parentNode.removeChild(outer);
      return [scrollbarWidthH, scrollbarWidthV];
    }

    let globalState = {
      scrollbarWidths: getScrollbarWidths(),
      data: [],
      downloadCsv: {},
      currentDataContainer: "countsContainer",
      weeklySurveysSettings: { year: 2022 },
      bleedsSettings: { year: 2022 },
      countsSettings: { },
      dom: {
        main: document.getElementById("main"),

        passwordBox: document.createElement("div"),

        data: {
          container: document.createElement("div"),
          sidebarSpecificSettingsContainer: document.createElement("div"),
          mainPageContainer: document.createElement("div"),

          weeklySurveysContainer: document.createElement("div"),
          weeklySurveysSettingsContainer: document.createElement("div"),
          bleedsContainer: document.createElement("div"),
          bleedsSettingsContainer: document.createElement("div"),
          countsContainer: document.createElement("div"),
          countsSettingsContainer: document.createElement("div"),

          surveyTableContainer: document.createElement("div"),
          surveyCompletionsContainer: document.createElement("div"),
        },

        loading: document.createElement("div"),
      },
    }

    const TABLE_ROW_HEIGHT_PX = 30

    const notNU = (val) => {
      let reuslt = val !== null && val !== undefined
      return result
    }

    const fieldsArePresent = (obj, colnames) => {
      let result = true
      let missingColnames = []
      for (let colname of colnames) {
        if (obj[colname] === undefined) {
          result = false
          missingColnames.push(colname)
        }
      }
      if (!result) {
        console.error(`fields ${missingColnames.join(",")} not present in`, obj)
      }
      return result
    }

    const arrSum = (arr) => {
      let result = 0
      for (let val of arr) {
        result += val
      }
      return result
    }

    const seq = (start, step, count) => {
      let result = [start]
      for (let i = 1; i < count; i += 1) {
        result.push(start + i * step)
      }
      return result
    }

    const dateSeq = (start, step, count) => {

      let result = []

      let startDate = new Date(start)
      let startDayIndex = startDate.getDate()

      for (let i = 0; i < count; i++) {
        let newDayIndex = startDayIndex + step * i
        let newDate = new Date(startDate)
        newDate.setDate(newDayIndex)
        result.push(newDate)
      }

      return result
    }

    const formatDate = (date) => {
      let result = date.toISOString().slice(0, 10)
      return result
    }

    const removeChildren = (element) => {
      while (element.lastChild) {
        element.removeChild(element.lastChild)
      }
    }

    const tableContainerStyle = (widthPx) => {
      let result = "height: calc(100vh - " + globalState.scrollbarWidths[0] +
      "px); overflow-x: hidden; overflow-y: scroll; width: "
      + (widthPx + globalState.scrollbarWidths[1]) +
      "px; display: flex; justify-content: center; flex-shrink: 0;"
      return result
    }

    const tableContentStyle = (widthPx, rowCount) => {
      let result = "width: " + widthPx + "px; height: " + (rowCount * TABLE_ROW_HEIGHT_PX) + "px;"
      return result
    }

    const createTableCellElement = (widthPx) => {
      let cellElement = document.createElement("div")
      cellElement.setAttribute(
        "style",
        "width: " + widthPx + "px; display: flex; align-items: center; justify-content: center;"
      )
      return cellElement
    }

    const createTableCellStringElement = (widthPx, string) => {
      let cellElement = createTableCellElement(widthPx)
      if (string !== undefined && string != null) {
        cellElement.innerHTML = string
      }
      return cellElement
    }

    const createTableRowElement = (color) => {
      let rowElement = document.createElement("div")
      rowElement.setAttribute("style",
        "display: flex; height: " + TABLE_ROW_HEIGHT_PX + "px;" + "background-color: " + color + ";"
      )
      return rowElement
    }

    const createTableTitleElement = (title) => {
      let titleElement = document.createElement("div")
      titleElement.setAttribute(
        "style",
        "display: flex; align-items: center; justify-content: center; background-color: var(--color-background2); cursor: pointer;"
      )
      titleElement.innerHTML = title + " â‡“"
      titleElement.addEventListener("click", (event) => {
        let csv = globalState.downloadCsv[title]
        if (csv) {
          let hidden = document.createElement("a")
          hidden.href = "data:text/csv;charset=utf-8," + encodeURI(csv)
          hidden.target = "_blank"
          hidden.download = title + ".csv"
          hidden.click()
        } else {
          console.error(`table '${title}' does not have a csv to download`)
        }
      })
      return titleElement
    }

    const createTableHeaderRowElement = (colWidthsPx) => {
      let headerRow = createTableRowElement("var(--color-border)")
      headerRow.setAttribute("style", headerRow.getAttribute("style") + "position: sticky; top: 0;")
      let colnames = Object.keys(colWidthsPx)

      for (let colname of colnames) {
        let colWidthPx = colWidthsPx[colname]
        let headerElement = createTableCellElement(colWidthPx)
        headerRow.appendChild(headerElement)
        headerElement.innerHTML = colname
      }

      return headerRow
    }

    const createTableDataRowElement = (rowIndex) => {
      let color = "var(--color-background)"
      if (rowIndex % 2 == 1) {
        color = "var(--color-background2)"
      }
      let rowElement = createTableRowElement(color)
      return rowElement
    }

    const createTableElementFromSoa = (soa, formatters, colWidthsPx, title) => {

      let tableWidthPx = arrSum(Object.values(colWidthsPx))

      let table = document.createElement("div")
      let colnames = Object.keys(soa)

      let titleElement = createTableTitleElement(title)
      table.appendChild(titleElement)

      let headerRow = createTableHeaderRowElement(colWidthsPx)
      table.appendChild(headerRow)

      if (colnames.length > 0) {
        let rowCount = soa[colnames[0]].length
        table.setAttribute("style", tableContentStyle(tableWidthPx, rowCount))

        for (let rowIndex = 0; rowIndex < rowCount; rowIndex += 1) {
          let rowElement = createTableDataRowElement(rowIndex)
          table.appendChild(rowElement)

          for (let colname of colnames) {
            let colData = soa[colname][rowIndex]
            let formatter = formatters[colname]
            let colDataFormatted = formatter(colData)

            let colWidthPx = colWidthsPx[colname]
            let cellElement = createTableCellStringElement(colWidthPx, colDataFormatted)
            rowElement.appendChild(cellElement)
          }
        }
      }

      return [table, tableWidthPx]
    }

    const createYearSwitch = (initYear, onUpdate) => {
      let yearSwitch = document.createElement("div")
      let currentYear = initYear

      for (let year = 2020; year <= 2022; year += 1) {
        let yearOption = document.createElement("div")
        yearSwitch.appendChild(yearOption)

        let baseStyle = "padding-top: 5px; padding-bottom: 5px; cursor: pointer;"
        let hoverStyle = baseStyle + "background-color: var(--color-background2);"
        let selectedStyle = baseStyle + "background-color: var(--color-selected);"

        if (year === initYear) {
          yearOption.setAttribute("style", selectedStyle)
        } else {
          yearOption.setAttribute("style", baseStyle)
        }

        yearOption.addEventListener("mouseover", (event) => {
          if (year !== currentYear) {
            yearOption.setAttribute("style", hoverStyle)
          }
        })
        yearOption.addEventListener("mouseout", (event) => {
          if (year !== currentYear) {
            yearOption.setAttribute("style", baseStyle)
          }
        })

        yearOption.addEventListener("click", async (event) => {
          if (year !== currentYear) {
            for (let child of yearSwitch.childNodes) {
              child.setAttribute("style", baseStyle)
            }
            yearOption.setAttribute("style", selectedStyle)
            currentYear = year
            onUpdate(year)
          }
        })

        yearOption.innerHTML = year
      }

      return yearSwitch
    }

    const updateSurveyTable = () => {

      removeChildren(globalState.dom.data.surveyTableContainer)
      let table = document.createElement("div")
      globalState.dom.data.surveyTableContainer.appendChild(table)

      let allData = globalState.data.weekly_surveys

      let colWidthsPx = {
        record_id: 100,
        week: 100,
        completed: 100,
        ari: 100,
      }
      let tableWidthPx = arrSum(Object.values(colWidthsPx))
      globalState.dom.data.surveyTableContainer.setAttribute(
        "style", tableContainerStyle(tableWidthPx)
      )

      table.appendChild(createTableTitleElement("Completed weekly surveys"))
      table.appendChild(createTableHeaderRowElement(colWidthsPx))

      let completions = {}
      let rowsShown = 0
      for (let row of allData) {

        if (row.redcap_project_year == globalState.weeklySurveysSettings.year) {

          let completed = row.weekly_symptom_survey_complete
          if (completed !== "0") {

            let week = row.survey_index

            let rowElement = createTableDataRowElement(rowsShown)
            rowsShown += 1
            table.appendChild(rowElement)

            let recordIdCell = createTableCellStringElement(colWidthsPx.record_id, row.record_id)
            rowElement.appendChild(recordIdCell)

            let weekCell = createTableCellStringElement(colWidthsPx.week, week)
            rowElement.appendChild(weekCell)

            let completedCell = createTableCellStringElement(colWidthsPx.completed, completed)
            rowElement.appendChild(completedCell)

            let ari = row.ari_definition
            let ariCell = createTableCellStringElement(colWidthsPx.ari, ari)
            rowElement.appendChild(ariCell)

            if (completions[row.record_id] === undefined) {
              completions[row.record_id] = []
            }
            completions[row.record_id].push(parseInt(week))

          }
        }
      }
      table.setAttribute("style", tableContentStyle(tableWidthPx, rowsShown))

      return completions
    }

    const updateCompletionsTable = (completions) => {

      removeChildren(globalState.dom.data.surveyCompletionsContainer)
      let table = document.createElement("div")
      globalState.dom.data.surveyCompletionsContainer.appendChild(table)

      let rows = Object.entries(completions)

      let colWidthsPx = {
        record_id: 100,
        completions: 300,
      }
      let tableWidthPx = arrSum(Object.values(colWidthsPx))
      table.setAttribute("style", tableContentStyle(tableWidthPx, rows.length))
      globalState.dom.data.surveyCompletionsContainer.setAttribute(
        "style", tableContainerStyle(tableWidthPx)
      )

      table.appendChild(createTableTitleElement("Weekly completions"))
      table.appendChild(createTableHeaderRowElement(colWidthsPx))

      let rowsShown = 0
      for (let [record, completedSurveys] of rows) {
        let rowElement = createTableDataRowElement(rowsShown)
        table.appendChild(rowElement)
        rowsShown += 1

        rowElement.appendChild(createTableCellStringElement(colWidthsPx.record_id, record))

        let collapsedCompletions = ""
        if (completedSurveys.length > 0) {
          collapsedCompletions += completedSurveys[0]
          if (completedSurveys.length > 1) {

            let prev = completedSurveys[0]
            let currentStreak = 1
            for (let completeIndex = 1; completeIndex < completedSurveys.length; completeIndex += 1) {
              let compl = completedSurveys[completeIndex]

              if (completeIndex == completedSurveys.length - 1) {

                if (currentStreak > 1) {
                  collapsedCompletions += "-"
                } else {
                  collapsedCompletions += ", "
                }
                collapsedCompletions += compl

              } else if (compl - prev == currentStreak) {

                currentStreak += 1

              } else {

                if (currentStreak > 1) {
                  let lastNotShown = prev + currentStreak - 1
                  collapsedCompletions += "-" + lastNotShown
                }

                collapsedCompletions += ", "
                collapsedCompletions += compl
                currentStreak = 1
                prev = compl
              }

            }
          }
        }

        rowElement.appendChild(createTableCellStringElement(colWidthsPx.completions, collapsedCompletions))
      }
    }

    const updateCountsTable = () => {

      removeChildren(globalState.dom.data.countsContainer)
      let countPage = document.createElement("div")
      globalState.dom.data.countsContainer.appendChild(countPage)

      let withdrawalData = globalState.data.withdrawal

      let withdrawals = {}
      for (let row of withdrawalData) {
        if (row.redcap_project_year === 2022) {
          let withdrawn = row.withdrawn === "1"
          if (withdrawn) {
            withdrawals[row.record_id] = true
          }
        }
      }

      let baselineData = globalState.data.baseline

      let siteCounts = {}
      for (let row of baselineData) {
        if (row.pid !== undefined && row.redcap_project_year === 2022) {

          if (row.pid.length >= 3) {
            let first3 = row.pid.slice(0, 3)
            if (siteCounts[first3] === undefined) {
              siteCounts[first3] = {total: 0, active: 0}
            }
            siteCounts[first3].total += 1

            let consent = row.consent === "1" || row.study_group_vacc === "1" ||
              row.study_group_vacc === "2" || row.consent_unvacc === "1"
            let withdrawn = withdrawals[row.record_id] === true
            if (consent && !withdrawn) {
              siteCounts[first3].active += 1
            }
          }
        }
      }

      //
      // NOTE(sen) Total counts
      //

      let totalCountsColWidthsPx = {
        site: 100,
        total: 100,
        active: 100,
      }
      let totalCountsWidthPx = arrSum(Object.values(totalCountsColWidthsPx))

      let totalCountsTableContainer = document.createElement("div")
      countPage.appendChild(totalCountsTableContainer)
      totalCountsTableContainer.setAttribute("style", tableContentStyle(totalCountsWidthPx))

      let totalCountsTable = document.createElement("div")
      totalCountsTableContainer.appendChild(totalCountsTable)

      totalCountsTable.appendChild(createTableTitleElement("Record counts"))
      totalCountsTable.appendChild(createTableHeaderRowElement(totalCountsColWidthsPx))

      let sitesTotal = 0
      let sitesActive = 0
      for (let [site, count] of Object.entries(siteCounts)) {
        let rowElement = createTableRowElement("var(--color-background)")
        totalCountsTable.appendChild(rowElement)

        sitesTotal += count.total
        sitesActive += count.active

        rowElement.appendChild(createTableCellStringElement(totalCountsColWidthsPx.site, site))
        rowElement.appendChild(createTableCellStringElement(totalCountsColWidthsPx.total, count.total))
        rowElement.appendChild(createTableCellStringElement(totalCountsColWidthsPx.active, count.active))
      }
      {
        let rowElement = createTableRowElement("var(--color-background)")
        totalCountsTable.appendChild(rowElement)
        rowElement.appendChild(createTableCellStringElement(totalCountsColWidthsPx.site, "Total"))
        rowElement.appendChild(createTableCellStringElement(totalCountsColWidthsPx.total, sitesTotal))
        rowElement.appendChild(createTableCellStringElement(totalCountsColWidthsPx.active, sitesActive))
      }
    }

    const updateBleedsTable = () => {
      removeChildren(globalState.dom.data.bleedsContainer)
      let bleedsTableContainer = document.createElement("div")
      globalState.dom.data.bleedsContainer.appendChild(bleedsTableContainer)

      let allData = globalState.data.baseline

      let colWidthsPx = {
        record_id: 100,
        pid: 100,
        baseline: 100,
        day7: 100,
        day14: 100,
        end: 100,
        day0Covid: 100,
        day7Covid: 100,
        day14Covid: 100,
      }
      let tableWidthPx = arrSum(Object.values(colWidthsPx))
      bleedsTableContainer.setAttribute("style", tableContainerStyle(tableWidthPx))

      let bleedsTable = document.createElement("div")
      bleedsTableContainer.appendChild(bleedsTable)
      let bleedsTableTitle = "Bleed dates"
      bleedsTable.appendChild(createTableTitleElement("Bleed dates"))
      globalState.downloadCsv[bleedsTableTitle] = Object.keys(colWidthsPx).join(",") + "\n"
      bleedsTable.appendChild(createTableHeaderRowElement(colWidthsPx))

      let rowsShown = 0
      for (let row of allData) {

        if (row.redcap_project_year === globalState.bleedsSettings.year) {
          const toString = (str) => {
            let result = ""
            if (str !== undefined && str !== null) {
              result = str
            }
            return result
          }

          let dateBaselineBlood = toString(row.date_baseline_blood)
          let date7dBlood = toString(row.date_7d_blood)
          let date14dBlood = toString(row.date_14d_blood)
          let dateEndSeasonBlood = toString(row.date_end_season_blood)
          let dateCovaxBaselineBlood = toString(row.covax_d0_sampdate)
          let dateCovax7dBlood = toString(row.covax_d7_sampdate)
          let dateCovax14dBlood = toString(row.covax_d14_sampdate)

          let worthShowing = dateBaselineBlood !== "" || date7dBlood !== "" || date14dBlood !== "" || dateEndSeasonBlood !== ""
          if (globalState.bleedsSettings.year > 2020) {
            worthShowing = worthShowing || dateCovaxBaselineBlood !== "" || dateCovax7dBlood !== "" || dateCovax14dBlood !== ""
          }

          if (worthShowing) {
            let rowElement = createTableDataRowElement(rowsShown)
            rowsShown += 1
            bleedsTable.appendChild(rowElement)

            let recordIdCell = createTableCellStringElement(colWidthsPx.record_id, row.record_id)
            rowElement.appendChild(recordIdCell)

            let pidCell = createTableCellStringElement(colWidthsPx.pid, row.pid)
            rowElement.appendChild(pidCell)

            let dateBaselineCell = createTableCellStringElement(colWidthsPx.baseline, dateBaselineBlood)
            rowElement.appendChild(dateBaselineCell)

            let day7Cell = createTableCellStringElement(colWidthsPx.day7, date7dBlood)
            rowElement.appendChild(day7Cell)

            let day14Cell = createTableCellStringElement(colWidthsPx.day14, date14dBlood)
            rowElement.appendChild(day14Cell)

            let endCell = createTableCellStringElement(colWidthsPx.end, dateEndSeasonBlood)
            rowElement.appendChild(endCell)

            let rowCsv = row.record_id + "," + row.pid + "," + dateBaselineBlood + "," + date7dBlood + "," + date14dBlood + "," + dateEndSeasonBlood

            if (globalState.bleedsSettings.year > 2020) {
              let day0CovidCell = createTableCellStringElement(colWidthsPx.day0Covid, dateCovaxBaselineBlood)
              rowElement.appendChild(day0CovidCell)

              let day7CovidCell = createTableCellStringElement(colWidthsPx.day7Covid, dateCovax7dBlood)
              rowElement.appendChild(day7CovidCell)

              let day14CovidCell = createTableCellStringElement(colWidthsPx.day14Covid, dateCovax14dBlood)
              rowElement.appendChild(day14CovidCell)

              rowCsv += "," + dateCovaxBaselineBlood + "," + dateCovax7dBlood + "," + dateCovax14dBlood
            }

            rowCsv += "\n"
            globalState.downloadCsv[bleedsTableTitle] += rowCsv
          }
        }
      }

      bleedsTable.setAttribute("style", tableContentStyle(tableWidthPx, rowsShown))
    }

    const updateAllTables = () => {
      let completions = updateSurveyTable()
      updateCompletionsTable(completions)
      updateCountsTable()
      updateBleedsTable()
    }

    const updateData = async (password) => {
      let success = true

      if (
        password === "" ||
        password === null ||
        password === undefined ||
        !(typeof password === "string" || password instanceof String)
      ) {

        success = false

      } else {

        let address =
          "https://reports2.hcwflustudy.com/api/" +
          password +
          "/redcap.json"

        //address = `/pull-redcap/redcap-all_data.json`

        try {
          let resp = await fetch(address)
          globalState.data = []
          globalState.data = await resp.json()
        } catch (e) {
          success = false
          console.error(e)
        }

        if (success) {
          updateAllTables()
        }
      }

      return success
    }

    const updateDataWithLoading = async (password) => {
      let dom = globalState.dom
      removeChildren(dom.main)
      dom.main.appendChild(dom.loading)
      let updateSuccess = await updateData(password)
      dom.main.removeChild(dom.loading)

      if (!updateSuccess) {
        localStorage.removeItem("password")
        dom.main.appendChild(dom.passwordBox)
      } else {
        dom.main.appendChild(dom.data.container)
      }
    }

    //
    // NOTE(sen) DOM secton
    //

    // NOTE(sen) Init password box
    {
      let dom = globalState.dom

      let container = dom.passwordBox
      let input = document.createElement("input")
      let label = document.createElement("div")
      let button = document.createElement("div")
      let buttonText = document.createElement("div")
      let errorText = document.createElement("div")
      container.appendChild(label)
      container.appendChild(input)
      container.appendChild(button)
      container.appendChild(errorText)
      button.appendChild(buttonText)

      input.setAttribute("type", "password")
      input.setAttribute("style", "width: 75vw; height: 2em;")

      label.innerHTML = "Password"
      buttonText.innerHTML = "Submit"

      container.setAttribute(
        "style",
        "width: 75vw; margin: auto; margin-top: 5vh"
      )

      button.setAttribute(
        "style",
        "cursor: pointer; border: 1px solid var(--color-border); height: 50px; width: 50%; margin: auto; margin-top: 10px; display: flex; align-items: center; justify-content: center;"
      )

      errorText.setAttribute(
        "style",
        "color: var(--color-error); text-align: center; margin-top: 10px"
      )

      button.addEventListener("click", async (e) => {
        if (buttonText.innerHTML !== "...") {
          errorText.innerHTML = ""
          if (input.value === "") {
            errorText.innerHTML = "Password is empty"
          } else {
            buttonText.innerHTML = "..."
            let updateSuccess = await updateData(input.value, [2022])
            if (!updateSuccess) {
              errorText.innerHTML = "Not recognized"
            } else {
              localStorage.setItem("password", input.value)
              dom.main.removeChild(container)
              dom.main.appendChild(dom.data.container)
            }
            buttonText.innerHTML = "Submit"
          }
        }
      })
    }

    // NOTE(sen) Init data page
    {
      let dom = globalState.dom
      let container = dom.data.container
      container.setAttribute("id", "dom-data-container")
      container.setAttribute("style", "display: flex")

      // NOTE(sen) Sidebar
      let sidebar = document.createElement("div")
      container.appendChild(sidebar)
      let sidebarWidthPx = 80
      sidebar.setAttribute(
        "style",
        "width: " + sidebarWidthPx +
        "px; flex-shrink: 0; display: flex; flex-direction: column; justify-content: space-between; height: 100vh; overflow-x: hidden;"
      )

      let sidebarTopContainer = document.createElement("div")
      sidebar.appendChild(sidebarTopContainer)
      sidebarTopContainer.setAttribute("style", "display: flex; flex-direction: column; row-gap: 20px;")

      // NOTE(sen) Data table switch
      let sidebarLinksContainer = document.createElement("div")
      sidebarTopContainer.appendChild(sidebarLinksContainer)

      let sidebarLinks = {
        "weeklySurveysContainer": {name: "Weekly surveys", settings: "weeklySurveysSettingsContainer"},
        "bleedsContainer": {name: "Bleeds", settings: "bleedsSettingsContainer"},
        "countsContainer": {name: "Counts", settings: "countsSettingsContainer"},
      }

      for (let [dest, other] of Object.entries(sidebarLinks)) {
        let name = other.name

        let link = document.createElement("div")
        sidebarLinksContainer.appendChild(link)

        let baseStyle = "padding-top: 5px; padding-bottom: 5px; cursor: pointer;"
        let hoverStyle = baseStyle + "background-color: var(--color-background2);"
        let selectedStyle = baseStyle + "background-color: var(--color-selected);"

        if (dest === globalState.currentDataContainer) {
          link.setAttribute("style", selectedStyle)
        } else {
          link.setAttribute("style", baseStyle)
        }

        link.innerHTML = name

        link.addEventListener("mouseover", (event) => {
          if (dest !== globalState.currentDataContainer) {
            link.setAttribute("style", hoverStyle)
          }
        })
        link.addEventListener("mouseout", (event) => {
          if (dest !== globalState.currentDataContainer) {
            link.setAttribute("style", baseStyle)
          }
        })

        link.addEventListener("click", (event) => {
          if (globalState.currentDataContainer !== dest) {

            for (let child of sidebarLinksContainer.childNodes) {
              child.setAttribute("style", baseStyle)
            }

            link.setAttribute("style", selectedStyle)

            // NOTE(sen) Data page container has 2 children - sidebar and content
            container.removeChild(container.lastChild)
            let destContainer = globalState.dom.data[dest]
            container.appendChild(destContainer)
            globalState.currentDataContainer = dest

            // NOTE(sen) Replace page-specific settings
            removeChildren(globalState.dom.data.sidebarSpecificSettingsContainer)
            globalState.dom.data.sidebarSpecificSettingsContainer.appendChild(
              globalState.dom.data[other.settings]
            )
          }
        })
      }

      // NOTE(sen) Page-specific settings
      sidebarTopContainer.appendChild(globalState.dom.data.sidebarSpecificSettingsContainer)

      globalState.dom.data.weeklySurveysSettingsContainer = createYearSwitch(
        globalState.weeklySurveysSettings.year,
        (year) => {
          globalState.weeklySurveysSettings.year = year
          updateSurveyTable()
        }
      )

      globalState.dom.data.bleedsSettingsContainer = createYearSwitch(
        globalState.bleedsSettings.year,
        (year) => {
          globalState.bleedsSettings.year = year
          updateBleedsTable()
        }
      )
      globalState.dom.data.countsSettingsContainer.innerHTML = "COUNTS SETTINGS"

      // NOTE(sen) Logout button
      let logoutButton = document.createElement("div")
      sidebar.appendChild(logoutButton)
      logoutButton.setAttribute("style", "cursor: pointer;")
      logoutButton.innerHTML = "Logout"
      logoutButton.addEventListener("mouseover", (event) => logoutButton.style.backgroundColor = "var(--color-selected)")
      logoutButton.addEventListener("mouseleave", (event) => logoutButton.style.backgroundColor = "inherit")
      logoutButton.addEventListener("click", (event) => {
        localStorage.removeItem("password")
        globalState.dom.main.removeChild(globalState.dom.data.container)
        globalState.dom.main.appendChild(globalState.dom.passwordBox)
      })

      let mainContentStyle = `display: flex; width: calc(100vw - ${sidebarWidthPx}px); overflow-x: scroll;`

      // NOTE(sen) Weekly surveys
      let weeklySurveysContainer = dom.data.weeklySurveysContainer
      weeklySurveysContainer.setAttribute("style", mainContentStyle)

      let datesTableContainer = document.createElement("div")
      let surveyTableContainer = dom.data.surveyTableContainer
      let surveyCompletionsContainer = dom.data.surveyCompletionsContainer

      weeklySurveysContainer.appendChild(datesTableContainer)
      weeklySurveysContainer.appendChild(surveyTableContainer)
      weeklySurveysContainer.appendChild(surveyCompletionsContainer)

      // NOTE(sen) Dates of weekly surveys only since we know them in advance

      let weeklySurveyDates2022 = {
        week: seq(1, 1, 52),
        start: dateSeq("2022-01-03", 7, 52),
        end: dateSeq("2022-01-09", 7, 52),
        send: dateSeq("2022-01-10", 7, 52),
      }

      let [weeklySurveyDates2022Table, tableWidth] = createTableElementFromSoa(
          weeklySurveyDates2022,
          {
            week: (x) => x,
            start: formatDate,
            end: formatDate,
            send: formatDate,
          },
          {
            week: 50,
            start: 100,
            end: 100,
            send: 100,
          },
          "Weekly survey dates 2022"
        )

      datesTableContainer.appendChild(weeklySurveyDates2022Table)
      datesTableContainer.setAttribute("style", tableContainerStyle(tableWidth))

      // NOTE(sen) Counts
      let countsContainer = dom.data.countsContainer
      countsContainer.setAttribute("style", mainContentStyle)


      // NOTE(sen) Bleeds
      let bleedsContainer = dom.data.bleedsContainer
      bleedsContainer.setAttribute("style", mainContentStyle)

      // NOTE(sen) Init the correct table and settings
      container.appendChild(globalState.dom.data[globalState.currentDataContainer])
      globalState.dom.data.sidebarSpecificSettingsContainer.appendChild(
        globalState.dom.data[sidebarLinks[globalState.currentDataContainer].settings]
      )
    }

    // NOTE(sen) Init loading indicator
    {
      let dom = globalState.dom
      let loading = dom.loading
      loading.setAttribute(
        "style",
        "font-size: 40px; display: flex; align-items: center; justify-content: center; height: 100vh"
      )
      loading.innerHTML = "Loading..."
    }

    // NOTE(sen) Attempt to login from local storage
    {
      let dom = globalState.dom
      let password = localStorage.getItem("password")

      if (password === null) {
        dom.main.appendChild(dom.passwordBox)
      } else {
        updateDataWithLoading(password)
      }
    }

    // TODO(sen) Paths
    // TODO(sen) Download all tables (current: bleed)
    // TODO(sen) Table filtering
    // TODO(sen) Table with emails and sites
    // TODO(sen) Correct weekly survey dates for 2020 and 2021
    // TODO(sen) Summary splits by prior vac / age / sex
    // TODO(sen) Retention across study years
  </script>
</html>
